name: "09 - Cost Tracking"

on:
  schedule:
    # Run twice daily to track costs
    - cron: '0 0,12 * * *'
  workflow_dispatch:
    inputs:
      report_type:
        description: 'Report type'
        required: false
        type: choice
        options:
          - daily
          - weekly
          - monthly
        default: daily

permissions:
  contents: write

jobs:
  track-costs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate workflow costs
        id: workflow_costs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ’° Calculating workflow costs..."
          
          # GitHub Actions pricing (approximate)
          # Free tier: 2000 minutes/month for private repos, unlimited for public
          # Beyond free: $0.008/minute for Linux runners
          
          # Get workflow runs from the last 24 hours
          SINCE_DATE=$(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-24H +%Y-%m-%dT%H:%M:%SZ)
          
          # Fetch recent workflow runs
          TOTAL_MINUTES=0
          
          # Note: This is a simplified cost calculation
          # Real implementation would use GitHub API to get actual workflow run durations
          
          cat > workflow-costs.json << EOF
          {
            "period": "last_24_hours",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "total_minutes": 0,
            "estimated_cost": 0.00,
            "note": "Cost tracking placeholder - integrate with GitHub API for real metrics"
          }
          EOF
          
          ESTIMATED_COST=$(jq -r '.estimated_cost' workflow-costs.json)
          echo "estimated_cost=$ESTIMATED_COST" >> $GITHUB_OUTPUT

      - name: Update budget tracking
        id: budget
        run: |
          echo "ðŸ“Š Updating budget tracking..."
          
          mkdir -p .github/automation
          TODAY=$(date +%Y-%m-%d)
          BUDGET_FILE=".github/automation/budget-$TODAY.json"
          
          # Initialize budget file if it doesn't exist
          if [ ! -f "$BUDGET_FILE" ]; then
            echo '{"date":"'$TODAY'","spent":0,"limit":25,"tasks":[],"cycles":0}' > "$BUDGET_FILE"
          fi
          
          # Read current budget
          SPENT=$(jq -r '.spent' "$BUDGET_FILE")
          LIMIT=$(jq -r '.limit' "$BUDGET_FILE")
          REMAINING=$(echo "$LIMIT - $SPENT" | bc)
          
          echo "spent=$SPENT" >> $GITHUB_OUTPUT
          echo "limit=$LIMIT" >> $GITHUB_OUTPUT
          echo "remaining=$REMAINING" >> $GITHUB_OUTPUT

      - name: Generate cost report
        run: |
          REPORT_TYPE="${{ github.event.inputs.report_type || 'daily' }}"
          
          echo "ðŸ“‹ Generating $REPORT_TYPE cost report..."
          
          mkdir -p .github/automation/reports
          REPORT_FILE=".github/automation/reports/cost-report-$(date +%Y%m%d).md"
          
          cat > "$REPORT_FILE" << EOF
          # Cost Tracking Report
          
          **Report Type:** $REPORT_TYPE
          **Generated:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          ## Current Budget Status
          - **Daily Limit:** \$$${{ steps.budget.outputs.limit }}
          - **Spent Today:** \$$${{ steps.budget.outputs.spent }}
          - **Remaining:** \$$${{ steps.budget.outputs.remaining }}
          
          ## Workflow Costs (Estimated)
          - **Last 24h Minutes:** Tracking via GitHub API
          - **Estimated Cost:** \$$${{ steps.workflow_costs.outputs.estimated_cost }}
          
          ## Notes
          Cost tracking is estimated based on GitHub Actions pricing.
          Actual costs may vary based on runner type and GitHub plan.
          EOF
          
          echo "âœ… Cost report generated: $REPORT_FILE"

      - name: Commit cost tracking
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config pull.rebase false
          
          # Pull latest changes first
          git pull origin master || echo "Pull failed, continuing..."
          
          git add .github/automation/
          
          # Check if there are changes to commit
          if ! git diff --staged --quiet; then
            git commit -m "chore: update cost tracking [skip ci]"
            
            # Retry push logic
            MAX_RETRIES=3
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if git push origin master; then
                echo "âœ… Successfully pushed changes"
                break
              else
                echo "âš ï¸ Push failed, pulling and retrying... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
                if git pull origin master --no-edit; then
                  RETRY_COUNT=$((RETRY_COUNT + 1))
                else
                  echo "âŒ Pull failed"
                  break
                fi
              fi
            done
          fi

      - name: Check for budget alerts
        id: alerts
        run: |
          REMAINING=${{ steps.budget.outputs.remaining }}
          LIMIT=${{ steps.budget.outputs.limit }}
          
          # Calculate percentage remaining
          PERCENT_REMAINING=$(echo "scale=0; $REMAINING * 100 / $LIMIT" | bc)
          
          if [ "$PERCENT_REMAINING" -le 10 ]; then
            echo "ðŸš¨ CRITICAL: Only $PERCENT_REMAINING% of daily budget remaining!"
            echo "level=critical" >> $GITHUB_OUTPUT
          elif [ "$PERCENT_REMAINING" -le 25 ]; then
            echo "âš ï¸ WARNING: Only $PERCENT_REMAINING% of daily budget remaining"
            echo "level=warning" >> $GITHUB_OUTPUT
          else
            echo "âœ… Budget healthy: $PERCENT_REMAINING% remaining"
            echo "level=ok" >> $GITHUB_OUTPUT
          fi
          
          echo "percent_remaining=$PERCENT_REMAINING" >> $GITHUB_OUTPUT

      - name: Send budget alert
        if: steps.alerts.outputs.level != 'ok' && env.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          LEVEL="${{ steps.alerts.outputs.level }}"
          EMOJI="${{ steps.alerts.outputs.level == 'critical' && 'ðŸš¨' || 'âš ï¸' }}"
          COLOR="${{ steps.alerts.outputs.level == 'critical' && '15158332' || '16776960' }}"
          
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"$EMOJI Budget Alert\",
                \"description\": \"Daily budget is running low!\",
                \"color\": $COLOR,
                \"fields\": [
                  {
                    \"name\": \"Remaining\",
                    \"value\": \"\$${{ steps.budget.outputs.remaining }} (${{ steps.alerts.outputs.percent_remaining }}%)\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Spent\",
                    \"value\": \"\$${{ steps.budget.outputs.spent }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Limit\",
                    \"value\": \"\$${{ steps.budget.outputs.limit }}\",
                    \"inline\": true
                  }
                ],
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" || echo "âš ï¸ Failed to send Discord notification"

      - name: Commit cost reports
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config pull.rebase false
          
          # Pull latest changes first
          git pull origin master || echo "Pull failed, continuing..."
          
          git add .github/automation/reports/
          
          # Check if there are changes to commit
          if ! git diff --staged --quiet; then
            git commit -m "chore: update cost tracking report"
            
            # Retry push logic
            MAX_RETRIES=3
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if git push origin master; then
                echo "âœ… Successfully pushed changes"
                break
              else
                echo "âš ï¸ Push failed, pulling and retrying... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
                if git pull origin master --no-edit; then
                  RETRY_COUNT=$((RETRY_COUNT + 1))
                else
                  echo "âŒ Pull failed"
                  break
                fi
              fi
            done
          fi

      - name: Summary
        run: |
          echo "## ðŸ’° Cost Tracking Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Budget Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Spent:** \$${{ steps.budget.outputs.spent }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Limit:** \$${{ steps.budget.outputs.limit }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Remaining:** \$${{ steps.budget.outputs.remaining }} (${{ steps.alerts.outputs.percent_remaining }}%)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Alert Level" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.alerts.outputs.level == 'critical' && 'ðŸš¨ CRITICAL' || steps.alerts.outputs.level == 'warning' && 'âš ï¸ WARNING' || 'âœ… OK' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Workflow Costs" >> $GITHUB_STEP_SUMMARY
          echo "- **Estimated (24h):** \$${{ steps.workflow_costs.outputs.estimated_cost }}" >> $GITHUB_STEP_SUMMARY
