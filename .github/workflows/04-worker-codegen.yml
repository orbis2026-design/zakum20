name: "04 - Worker Codegen"

on:
  workflow_dispatch:
    inputs:
      module_id:
        description: 'Module ID (e.g., zakum-achievements)'
        required: true
        type: string
      plugin_name:
        description: 'Plugin name (e.g., OrbisAchievements)'
        required: true
        type: string
      kind:
        description: 'Module kind (plugin or bridge)'
        required: false
        type: choice
        options:
          - plugin
          - bridge
        default: plugin

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-module:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up PowerShell
        run: |
          # PowerShell Core is already installed on Ubuntu runners
          pwsh --version

      - name: Generate module scaffolding
        id: generate
        run: |
          echo "ðŸ—ï¸ Generating module: ${{ github.event.inputs.module_id }}"
          
          # Run the module generator script
          pwsh -NoProfile -ExecutionPolicy Bypass -File tools/new-plugin-module.ps1 \
            -ModuleId "${{ github.event.inputs.module_id }}" \
            -PluginName "${{ github.event.inputs.plugin_name }}" \
            -Kind "${{ github.event.inputs.kind }}"
          
          if [ $? -eq 0 ]; then
            echo "âœ… Module generated successfully"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Module generation failed"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Verify generated module
        id: verify
        run: |
          MODULE_ID="${{ github.event.inputs.module_id }}"
          
          echo "ðŸ” Verifying generated module..."
          
          # Check if module directory exists
          if [ ! -d "$MODULE_ID" ]; then
            echo "âŒ Module directory not found"
            exit 1
          fi
          
          # Check for required files
          REQUIRED_FILES=(
            "$MODULE_ID/build.gradle.kts"
            "$MODULE_ID/src/main/resources/plugin.yml"
            "$MODULE_ID/src/main/resources/config.yml"
            "$MODULE_ID/README.md"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Required file not found: $file"
              exit 1
            fi
          done
          
          echo "âœ… All required files present"

      - name: Run verification gates
        id: gates
        run: |
          echo "ðŸ” Running verification gates..."
          
          # Verify platform infrastructure
          if ./gradlew verifyPlatformInfrastructure --no-daemon; then
            echo "âœ… Platform infrastructure verification passed"
          else
            echo "âŒ Platform infrastructure verification failed"
            exit 1
          fi
          
          # Try to compile the new module
          MODULE_ID="${{ github.event.inputs.module_id }}"
          if ./gradlew :$MODULE_ID:assemble --no-daemon; then
            echo "âœ… Module compilation successful"
          else
            echo "âŒ Module compilation failed"
            exit 1
          fi

      - name: Create Pull Request
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          MODULE_ID="${{ github.event.inputs.module_id }}"
          PLUGIN_NAME="${{ github.event.inputs.plugin_name }}"
          BRANCH_NAME="automation/codegen-$MODULE_ID"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config pull.rebase false
          
          # Pull latest changes first
          git pull origin master || echo "Pull failed, continuing..."
          
          git checkout -b "$BRANCH_NAME"
          git add .
          
          # Check if there are changes to commit
          if ! git diff --staged --quiet; then
            git commit -m "feat: generate $MODULE_ID module ($PLUGIN_NAME)"
            git push -u origin "$BRANCH_NAME"
            
            gh pr create \
              --title "feat: Generate $MODULE_ID module" \
              --body "Auto-generated module scaffolding for $PLUGIN_NAME (${{ github.event.inputs.kind }})" \
              --base master \
              --head "$BRANCH_NAME" || echo "PR already exists"
          fi

      - name: Summary
        run: |
          echo "## ðŸ—ï¸ Module Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Module ID:** ${{ github.event.inputs.module_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Plugin Name:** ${{ github.event.inputs.plugin_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Kind:** ${{ github.event.inputs.kind }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Successfully generated and verified" >> $GITHUB_STEP_SUMMARY
