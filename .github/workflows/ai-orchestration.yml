name: AI Orchestration - Sonnet 4.5 + GPT-4o Mini

on:
  schedule:
    # Run every 2.5-3 hours (optimal for $15/month budget with ~479 monthly executions)
    # Schedule pattern: Runs at 00:00, 02:30, 05:00, 07:30, 10:00, 12:30, 15:00, 17:30, 20:00, 22:30 UTC
    # This achieves approximately 10 executions per day = ~300 executions per month
    - cron: '0 0,2,5,7,10,12,15,17,20,22 * * *'  # On the hour runs
    - cron: '30 2,7,12,17,22 * * *'              # Half-hour runs
  
  workflow_dispatch:
    inputs:
      task_description:
        description: 'Task description for manual execution'
        required: false
        default: 'Parse next task from documentation'

env:
  PYTHON_VERSION: '3.11'

jobs:
  check-budget:
    name: Check Budget & Execute
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required for git push (budget updates)
      pull-requests: write  # Required for PR creation
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests anthropic openai
      
      - name: Check Budget Status
        id: budget_check
        run: |
          cd automation
          
          # Run orchestrator and capture output
          python orchestrator.py > /tmp/orchestrator_output.txt 2>&1 || true
          
          # Display output for debugging
          cat /tmp/orchestrator_output.txt
          
          # Check if budget is exhausted
          if grep -q "Budget exhausted\|cannot execute" /tmp/orchestrator_output.txt; then
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            echo "Budget exhausted. Stopping workflow."
            exit 0
          else
            echo "can_proceed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Parse Next Task
        id: parse_task
        if: steps.budget_check.outputs.can_proceed == 'true'
        run: |
          # Check for manual task input
          if [ -n "${{ github.event.inputs.task_description }}" ]; then
            TASK="${{ github.event.inputs.task_description }}"
          else
            # Parse next task from documentation
            # This would typically read from a task queue or documentation file
            TASK="Implement next feature from documentation backlog"
          fi
          
          echo "task_description=$TASK" >> $GITHUB_OUTPUT
          echo "Task: $TASK"
      
      - name: Execute AI Orchestration
        id: execute
        if: steps.budget_check.outputs.can_proceed == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cd automation
          python orchestrator.py "${{ steps.parse_task.outputs.task_description }}"
          
          # Check if execution was successful
          if [ $? -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "✅ Execution successful"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "❌ Execution failed"
            exit 1
          fi
      
      - name: Commit Budget Updates
        if: steps.budget_check.outputs.can_proceed == 'true'
        run: |
          git config user.name "AI Orchestrator Bot"
          git config user.email "bot@zakum.ai"
          
          git add token_budget.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update token budget after execution #${{ github.run_number }}"
            git push
          fi
      
      - name: Create PR (Placeholder)
        if: steps.execute.outputs.success == 'true'
        run: |
          echo "PR creation would happen here"
          echo "In production, this would:"
          echo "1. Create a new branch"
          echo "2. Apply generated code changes"
          echo "3. Commit changes"
          echo "4. Create pull request"
          echo "5. Link PR number back to cost tracking"
      
      - name: Upload Budget Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: budget-report-${{ github.run_number }}
          path: token_budget.json
          retention-days: 90

  monthly-summary:
    name: Generate Monthly Summary
    runs-on: ubuntu-latest
    # Run on the 1st of each month at 00:00 UTC
    if: github.event.schedule == '0 0 1 * *' || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: read  # Only need to read for monthly summary
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: Generate Monthly Report
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          cd automation
          python -c "
          import json
          from discord_notifier import DiscordNotifier
          
          with open('../token_budget.json', 'r') as f:
              budget_data = json.load(f)
          
          notifier = DiscordNotifier()
          notifier.send_monthly_recap(budget_data)
          "
