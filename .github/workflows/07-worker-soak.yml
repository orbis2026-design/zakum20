name: "07 - Worker Soak"

on:
  workflow_dispatch:
    inputs:
      duration_hours:
        description: 'Soak test duration (hours)'
        required: false
        type: number
        default: 12
      player_count:
        description: 'Simulated player count'
        required: false
        type: number
        default: 500
  schedule:
    # Run weekly on Saturday at midnight for long-running soak tests
    - cron: '0 0 * * 6'

permissions:
  contents: read
  issues: write

jobs:
  soak-test:
    runs-on: ubuntu-latest
    timeout-minutes: 720  # 12 hours max
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          # TODO: Re-enable cache when GitHub cache service is stable
          # Change cache-disabled: true to cache-disabled: false
          cache-disabled: true  # Temporarily disabled due to GitHub cache service outage

      - name: Build artifacts
        run: |
          echo "ðŸ”¨ Building artifacts for soak testing..."
          ./gradlew build -x test --no-daemon

      - name: Prepare soak test environment
        id: prepare
        run: |
          echo "ðŸ—ï¸ Preparing soak test environment..."
          
          DURATION=${{ github.event.inputs.duration_hours || 12 }}
          PLAYERS=${{ github.event.inputs.player_count || 500 }}
          
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "players=$PLAYERS" >> $GITHUB_OUTPUT
          
          mkdir -p soak-results
          
          cat > soak-config.json << EOF
          {
            "duration_hours": $DURATION,
            "player_count": $PLAYERS,
            "start_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "test_profiles": [
              "memory_stress",
              "task_saturation",
              "queue_backpressure",
              "cache_lifecycle"
            ]
          }
          EOF
          
          echo "âœ… Soak test configuration created"

      - name: Run memory stress profile
        id: memory
        run: |
          echo "ðŸ§  Running memory stress profile..."
          
          # Simulate memory stress testing
          cat > soak-results/memory-profile.json << 'EOF'
          {
            "profile": "memory_stress",
            "status": "simulated",
            "baseline_mb": 512,
            "peak_mb": 1024,
            "average_mb": 768,
            "gc_collections": 150,
            "memory_leaks_detected": false,
            "notes": "Soak test infrastructure placeholder - real implementation pending"
          }
          EOF
          
          echo "status=simulated" >> $GITHUB_OUTPUT

      - name: Run task saturation profile
        id: tasks
        run: |
          echo "âš¡ Running task saturation profile..."
          
          cat > soak-results/task-profile.json << 'EOF'
          {
            "profile": "task_saturation",
            "status": "simulated",
            "scheduled_tasks": 5000,
            "completed_tasks": 4998,
            "failed_tasks": 2,
            "average_latency_ms": 15,
            "max_latency_ms": 250,
            "task_queue_overflow": false,
            "notes": "Soak test infrastructure placeholder - real implementation pending"
          }
          EOF
          
          echo "status=simulated" >> $GITHUB_OUTPUT

      - name: Run queue backpressure profile
        id: queues
        run: |
          echo "ðŸ“¦ Running queue backpressure profile..."
          
          cat > soak-results/queue-profile.json << 'EOF'
          {
            "profile": "queue_backpressure",
            "status": "simulated",
            "queue_depth_max": 1000,
            "queue_depth_average": 250,
            "backpressure_events": 5,
            "dropped_tasks": 0,
            "notes": "Soak test infrastructure placeholder - real implementation pending"
          }
          EOF
          
          echo "status=simulated" >> $GITHUB_OUTPUT

      - name: Generate soak test report
        run: |
          echo "## ðŸ”¥ Soak Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Duration:** ${{ steps.prepare.outputs.duration }} hours" >> $GITHUB_STEP_SUMMARY
          echo "**Simulated Players:** ${{ steps.prepare.outputs.players }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Profiles:**" >> $GITHUB_STEP_SUMMARY
          echo "- Memory Stress: ${{ steps.memory.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Task Saturation: ${{ steps.tasks.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Queue Backpressure: ${{ steps.queues.outputs.status }}" >> $GITHUB_STEP_SUMMARY

      - name: Run cache lifecycle profile
        id: cache
        run: |
          echo "ðŸ’¾ Running cache lifecycle profile..."
          
          cat > soak-results/cache-profile.json << 'EOF'
          {
            "profile": "cache_lifecycle",
            "status": "simulated",
            "cache_entries_created": 10000,
            "cache_entries_evicted": 9500,
            "cache_entries_remaining": 500,
            "cache_hit_rate": 0.85,
            "cache_miss_rate": 0.15,
            "ttl_violations": 0,
            "memory_leak_detected": false,
            "notes": "Soak test infrastructure placeholder - real implementation pending"
          }
          EOF
          
          echo "status=simulated" >> $GITHUB_OUTPUT

      - name: Analyze results
        id: analyze
        run: |
          echo "ðŸ“Š Analyzing soak test results..."
          
          # Check for failures or anomalies
          FAILURES=0
          WARNINGS=0
          
          # Memory leaks check
          if jq -e '.memory_leaks_detected == true' soak-results/memory-profile.json > /dev/null 2>&1; then
            FAILURES=$((FAILURES + 1))
            echo "âŒ Memory leak detected"
          fi
          
          # Task failures check
          FAILED_TASKS=$(jq -r '.failed_tasks' soak-results/task-profile.json)
          if [ "$FAILED_TASKS" -gt 10 ]; then
            WARNINGS=$((WARNINGS + 1))
            echo "âš ï¸ High task failure rate: $FAILED_TASKS"
          fi
          
          # Queue overflow check
          if jq -e '.queue_overflow_events > 0' soak-results/queue-profile.json > /dev/null 2>&1; then
            FAILURES=$((FAILURES + 1))
            echo "âŒ Queue overflow detected"
          fi
          
          # Cache memory leak check
          if jq -e '.memory_leak_detected == true' soak-results/cache-profile.json > /dev/null 2>&1; then
            FAILURES=$((FAILURES + 1))
            echo "âŒ Cache memory leak detected"
          fi
          
          echo "failures=$FAILURES" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          
          if [ "$FAILURES" -eq 0 ]; then
            echo "âœ… Soak test completed successfully"
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ Soak test failed with $FAILURES failure(s)"
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Generate soak report
        if: always()
        run: |
          cat > soak-results/REPORT.md << 'EOF'
          # Soak Test Report
          
          **Test Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Duration:** ${{ steps.prepare.outputs.duration }} hours
          **Simulated Players:** ${{ steps.prepare.outputs.players }}
          
          ## Results Summary
          
          | Profile | Status |
          |---------|--------|
          | Memory Stress | ${{ steps.memory.outputs.status == 'passed' && 'âœ… Passed' || 'âš ï¸ Simulated' }} |
          | Task Saturation | ${{ steps.tasks.outputs.status == 'passed' && 'âœ… Passed' || 'âš ï¸ Simulated' }} |
          | Queue Backpressure | ${{ steps.queues.outputs.status == 'passed' && 'âœ… Passed' || 'âš ï¸ Simulated' }} |
          | Cache Lifecycle | ${{ steps.cache.outputs.status == 'passed' && 'âœ… Passed' || 'âš ï¸ Simulated' }} |
          
          ## Overall Status
          
          **Failures:** ${{ steps.analyze.outputs.failures }}
          **Warnings:** ${{ steps.analyze.outputs.warnings }}
          **Status:** ${{ steps.analyze.outputs.status == 'passed' && 'âœ… PASSED' || 'âŒ FAILED' }}
          
          ## Notes
          
          This is a simulated soak test report. Real implementation requires:
          - Paper server test environment
          - Player simulation framework
          - Metrics collection infrastructure
          - Long-running test orchestration
          
          See `docs/stress-harness-v2.md` for implementation details.
          
          ---
          *This report was generated by the Zakum Soak Test Worker*
          EOF
          
          cat soak-results/REPORT.md

      - name: Upload soak results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: soak-test-results
          path: soak-results/

      - name: Create issue for failures
        if: steps.analyze.outputs.status == 'failed'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Soak Test Failed',
              body: `## Soak Test Failure Report\n\n**Date:** ${new Date().toISOString()}\n**Duration:** ${{ steps.prepare.outputs.duration }} hours\n**Players:** ${{ steps.prepare.outputs.players }}\n\n**Failures:** ${{ steps.analyze.outputs.failures }}\n**Warnings:** ${{ steps.analyze.outputs.warnings }}\n\nPlease review the soak test results and address any issues.\n\n[View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['soak-test', 'failure', 'performance']
            });

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ”¬ Soak Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Duration:** ${{ steps.prepare.outputs.duration }} hours" >> $GITHUB_STEP_SUMMARY
          echo "**Players:** ${{ steps.prepare.outputs.players }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Profile | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Memory Stress | ${{ steps.memory.outputs.status == 'passed' && 'âœ… Passed' || 'âš ï¸ Simulated' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Task Saturation | ${{ steps.tasks.outputs.status == 'passed' && 'âœ… Passed' || 'âš ï¸ Simulated' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Queue Backpressure | ${{ steps.queues.outputs.status == 'passed' && 'âœ… Passed' || 'âš ï¸ Simulated' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Lifecycle | ${{ steps.cache.outputs.status == 'passed' && 'âœ… Passed' || 'âš ï¸ Simulated' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Status:** ${{ steps.analyze.outputs.status == 'passed' && 'âœ… PASSED' || 'âŒ FAILED' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Failures:** ${{ steps.analyze.outputs.failures }}" >> $GITHUB_STEP_SUMMARY
          echo "**Warnings:** ${{ steps.analyze.outputs.warnings }}" >> $GITHUB_STEP_SUMMARY
